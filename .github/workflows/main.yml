name: Run Unit Tests

on:
  pull_request:
    branches: [ main, master, develop ]
  push:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        # pip install -r requirements.txt
        
    - name: Run tests with unittest
      id: run_tests
      run: |
        echo "üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å unittest..."
        echo "================================"
        echo ""
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã —á–µ—Ä–µ–∑ unittest –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–≤–æ–¥
        python -m unittest testing.tests -v 2>&1 | tee test_output.txt
        
        echo ""
        echo "üìä –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤..."
        echo "========================"
        
    - name: Analyze and display results
      if: always()
      run: |
        echo "=== –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–û–í ==="
        echo ""
        
        if [ -f "test_output.txt" ]; then
          # –í—ã–≤–æ–¥–∏–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          echo "üìà –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
          echo "----------------------"
          
          # –°—á–∏—Ç–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          TOTAL_TESTS=$(grep -c "^test_" test_output.txt || echo "0")
          OK_TESTS=$(grep -c "OK" test_output.txt || echo "0")
          FAILED_TESTS=$(grep -c "FAIL" test_output.txt || echo "0")
          ERROR_TESTS=$(grep -c "ERROR" test_output.txt || echo "0")
          
          # –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å –∏—Ç–æ–≥–∞–º–∏ (–æ–±—ã—á–Ω–æ –≤ –∫–æ–Ω—Ü–µ –≤—ã–≤–æ–¥–∞ unittest)
          FINAL_RESULT=$(tail -5 test_output.txt | grep -E "OK|FAIL|ERROR")
          
          echo "–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: $TOTAL_TESTS"
          echo "–ü—Ä–æ–π–¥–µ–Ω–æ: $OK_TESTS"
          echo "–ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ: $FAILED_TESTS"
          echo "–û—à–∏–±–æ–∫: $ERROR_TESTS"
          echo ""
          
          echo "üìã –î–µ—Ç–∞–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:"
          echo "-------------------"
          
          if [[ -n "$FINAL_RESULT" ]]; then
            echo "–§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: $FINAL_RESULT"
          fi
          echo ""
          
          # –í—ã–≤–æ–¥–∏–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
          echo "üìù –°–ø–∏—Å–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤:"
          echo "----------------------------"
          grep -E "^(test_|OK|FAIL|ERROR)" test_output.txt
          echo ""
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
          if [ "$FAILED_TESTS" -gt 0 ] || [ "$ERROR_TESTS" -gt 0 ]; then
            echo "‚ùå ‚ùå ‚ùå –û–ë–ù–ê–†–£–ñ–ï–ù–´ –ü–†–û–ë–õ–ï–ú–´ ‚ùå ‚ùå ‚ùå"
            echo ""
            echo "–£–ø–∞–≤—à–∏–µ —Ç–µ—Å—Ç—ã:"
            echo "--------------"
            grep -B1 "FAIL\|ERROR" test_output.txt
            echo ""
            exit 1
          else
            echo "‚úÖ ‚úÖ ‚úÖ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û! ‚úÖ ‚úÖ ‚úÖ"
            echo ""
            echo "üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—Å–µ $TOTAL_TESTS —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω—ã."
          fi
        else
          echo "‚ö†Ô∏è –§–∞–π–ª —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ç–µ—Å—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          exit 1
        fi
