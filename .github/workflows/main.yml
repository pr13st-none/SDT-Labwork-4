name: Run Unit Tests

on:
  pull_request:
    branches: [ main, master, develop ]
  push:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
        # pip install numpy  # –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        
    - name: Install pytest
      run: |
        pip install pytest
        
    - name: Run unit tests with detailed output
      id: run_tests  # –î–æ–±–∞–≤–ª—è–µ–º id –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
      run: |
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–≤–æ–¥
        python -m pytest tests/tests.py -v --tb=short 2>&1 | tee test_output.txt
        
    - name: Save test results
      if: always()  # –í—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ–º —ç—Ç–æ—Ç —à–∞–≥, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏
      run: |
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ –≤ —Ñ–∞–π–ª –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞
        python -c "
        import os
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª —Å –≤—ã–≤–æ–¥–æ–º —Ç–µ—Å—Ç–æ–≤
        if os.path.exists('test_output.txt'):
            with open('test_output.txt', 'r') as f:
                content = f.read()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à–ª–∏ –ª–∏ –≤—Å–µ —Ç–µ—Å—Ç—ã
            if 'FAILED' in content:
                print('::set-output name=test_status::failed')
                print('::set-output name=test_summary::–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏')
            elif 'PASSED' in content or 'passed' in content:
                print('::set-output name=test_status::passed')
                print('::set-output name=test_summary::–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ')
            else:
                print('::set-output name=test_status::unknown')
                print('::set-output name=test_summary::–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–æ–≤')
        else:
            print('::set-output name=test_status::error')
            print('::set-output name=test_summary::–§–∞–π–ª —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ç–µ—Å—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω')
        "
        
    - name: Display test results summary
      if: always()
      run: |
        echo "=== –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–û–í ==="
        echo ""
        
        if [ -f "test_output.txt" ]; then
          # –í—ã–≤–æ–¥–∏–º –∫—Ä–∞—Ç–∫—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤:"
          echo "---------------------"
          grep -E "(PASSED|FAILED|ERROR|test_.*\.py)" test_output.txt | head -20
          echo ""
          
          # –ò—â–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          echo "üìà –ò—Ç–æ–≥–∏:"
          echo "---------"
          grep -A2 -B2 "passed\|failed\|ERROR" test_output.txt | tail -10
          echo ""
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤
          TEST_COUNT=$(grep -c "test_" test_output.txt || true)
          PASSED_COUNT=$(grep -c "PASSED" test_output.txt || true)
          FAILED_COUNT=$(grep -c "FAILED" test_output.txt || true)
          ERROR_COUNT=$(grep -c "ERROR" test_output.txt || true)
          
          echo "üìã –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
          echo "------------------------"
          echo "–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ: $TEST_COUNT"
          echo "–ü—Ä–æ–π–¥–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ: $PASSED_COUNT"
          echo "–ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ: $FAILED_COUNT"
          echo "–û—à–∏–±–æ–∫: $ERROR_COUNT"
          echo ""
          
          # –í—ã–≤–æ–¥–∏–º —Å–ø–∏—Å–æ–∫ —É–ø–∞–≤—à–∏—Ö —Ç–µ—Å—Ç–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
          if [ "$FAILED_COUNT" -gt 0 ]; then
            echo "‚ùå –£–ø–∞–≤—à–∏–µ —Ç–µ—Å—Ç—ã:"
            echo "----------------"
            grep -B2 "FAILED\|AssertionError" test_output.txt
            echo ""
          fi
          
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "‚ö†Ô∏è –¢–µ—Å—Ç—ã —Å –æ—à–∏–±–∫–∞–º–∏:"
            echo "-------------------"
            grep -B2 "ERROR" test_output.txt
            echo ""
          fi
          
          # –í—ã–≤–æ–¥–∏–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
          if [ "$FAILED_COUNT" -eq 0 ] && [ "$ERROR_COUNT" -eq 0 ]; then
            echo "‚úÖ ‚úÖ ‚úÖ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û! ‚úÖ ‚úÖ ‚úÖ"
          else
            echo "‚ùå ‚ùå ‚ùå –ï–°–¢–¨ –ü–†–û–ë–õ–ï–ú–´ –í –¢–ï–°–¢–ê–•! ‚ùå ‚ùå ‚ùå"
            exit 1  # –ó–∞–≤–µ—Ä—à–∞–µ–º —Å –æ—à–∏–±–∫–æ–π, –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏
          fi
          
        else
          echo "‚ö†Ô∏è –§–∞–π–ª —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ç–µ—Å—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          exit 1
        fi
        
    - name: Upload test results as artifact
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: |
          test_output.txt
        retention-days: 7
